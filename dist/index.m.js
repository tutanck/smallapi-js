import r from"lodash";import e from"isarray";import t from"url-parse";import n from"remove-trailing-slash";import o from"axios";import{createInstance as i,makeGet as s,makePost as u,makePut as a,makeDel as c}from"@tutanck/axios";import l from"qs";var f="/api",d="/conf";function v(){return v=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)({}).hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},v.apply(null,arguments)}var g=o.create(),y=function(r,e){return g(v({method:"get",url:r},e)).then(function(r){return r.data}).catch(function(r){throw r})},m=function(o,g){var m=g.apiKey,h=void 0===m?null:m,p=g.decodeKey,b=void 0===p?null:p,P=g.debug,B=void 0!==P&&P;try{if(!o)throw new Error("'serverUrl' cannot be undefined or null.");return!0===B&&console.log({serverUrl:o,apiKey:h,decodeKey:b,debug:B}),Promise.resolve(function(o,i){try{var s,u;return!0===(u=void 0!==(s=i.debug)&&s)&&console.log("-> fetching",o),Promise.resolve(y(o,{}).then(function(i){try{var s,a=function(r){var e=t(o);return{descriptor:s,serverRootUrl:e.protocol+"//"+e.host,apiBaseUri:f}},c=function(){if(function(r){var e;void 0===r&&(r=[]);var t=r.find(function(r){return(null==r?void 0:r.path)===d});return Boolean(null==t||null==(e=t.methods)?void 0:e.includes("GET"))}(i))return function(t,i){try{var a=(c=""+n(o)+d,!0===u&&console.log("-> fetching",c),Promise.resolve(y(c,{})).then(function(t){var n=t.routing[f];if(!(e(n)&&n.length>0))throw new Error("Invalid or empty api-map");s=r.groupBy(n,"name")}))}catch(r){return i(r)}var c;return a&&a.then?a.then(void 0,i):a}(0,function(r){throw console.error(r),new Error("Api conf unreachable on server '"+o+"'")});throw new Error("Api conf not found on server '"+o+"'")}();return Promise.resolve(c&&c.then?c.then(a):a())}catch(r){return Promise.reject(r)}}).catch(function(r){throw console.error(r),new Error("Unable to connect to server '"+o+"'")}))}catch(r){return Promise.reject(r)}}(o,{debug:B})).then(function(r){var e=r.descriptor,t=function(r){var e=r.apiBaseUri,t=r.apiKey,o=r.decodeKey,l=[n(r.serverRootUrl),e].join(""),f=i({baseURL:l,headers:{authorization:t}});return{get:s(f,{encryption:{decodeKey:o}}),post:u(f,{encryption:{decodeKey:o}}),put:a(f,{encryption:{decodeKey:o}}),del:c(f,{encryption:{decodeKey:o}})}}({serverRootUrl:r.serverRootUrl,apiBaseUri:r.apiBaseUri,decodeKey:b,apiKey:h}),o=function(r,e,t){var n=e.get,o=e.post,i=e.put,s=e.del,u=t.debug,a=void 0!==u&&u,c=Object.entries(r).reduce(function(r,e){var t,u=e[1],c=function(r){if(r.endsWith("Routine")){var e=r.substring(0,r.length-7);if(r.startsWith("count"))return"count"+e.substring(5,r.length);if(r.startsWith("create"))return"create"+e.substring(6,r.length);if(r.startsWith("findById"))return"find"+e.substring(8,r.length)+"ById";if(r.startsWith("findByQuery"))return"find"+e.substring(11,r.length)+"ByQuery";if(r.startsWith("removeById"))return"remove"+e.substring(10,r.length)+"ByQuery";if(r.startsWith("removeByQuery"))return"remove"+e.substring(13,r.length)+"ByQuery";if(r.startsWith("updateById"))return"update"+e.substring(10,r.length)+"ById";if(r.startsWith("updateByQuery"))return"update"+e.substring(13,r.length)+"ByQuery"}return r}(e[0]),f=function(r,e,t){var n=r.uri,o=r.name,i=r.verb,s=t.debug,u=void 0!==s&&s,a=t.fnName,c={PUT:e.put,GET:e.get,POST:e.post,DELETE:e.del}[i];if(o.endsWith("Routine")){if(o.startsWith("count"))return function(r){try{var e=n+"?"+l.stringify({filter:r});return!0===u&&(console.log({fnName:a,uri:n,name:o,verb:i}),console.log(i+" '"+e+"'")),Promise.resolve(c(e))}catch(r){return Promise.reject(r)}};if(o.startsWith("create"))return function(r,e){void 0===e&&(e={});try{var t=n+"?"+l.stringify({options:e}),s={data:{docs:r}};return!0===u&&(console.log({fnName:a,uri:n,name:o,verb:i}),console.log(i+" '"+t+"' with data: "+JSON.stringify(s))),Promise.resolve(c(t,s))}catch(r){return Promise.reject(r)}};if(o.startsWith("findById"))return function(r,e,t){void 0===e&&(e={}),void 0===t&&(t={});try{var s=""+n+r+"?"+l.stringify({projection:e,options:t});return!0===u&&(console.log({fnName:a,uri:n,name:o,verb:i}),console.log(i+" '"+s+"'")),Promise.resolve(c(s))}catch(r){return Promise.reject(r)}};if(o.startsWith("findByQuery"))return function(r,e,t){void 0===e&&(e={}),void 0===t&&(t={});try{var s=n+"?"+l.stringify({filter:r,projection:e,options:t});return!0===u&&(console.log({fnName:a,uri:n,name:o,verb:i}),console.log(i+" '"+s+"'")),Promise.resolve(c(s))}catch(r){return Promise.reject(r)}};if(o.startsWith("removeById"))return function(r,e){void 0===e&&(e={});try{var t=""+n+r+"?"+l.stringify({options:e});return!0===u&&(console.log({fnName:a,uri:n,name:o,verb:i}),console.log(i+" '"+t+"'")),Promise.resolve(c(t))}catch(r){return Promise.reject(r)}};if(o.startsWith("removeByQuery"))return function(r,e){void 0===e&&(e={});try{var t=n+"?"+l.stringify({filter:r,options:e});return!0===u&&(console.log({fnName:a,uri:n,name:o,verb:i}),console.log(i+" '"+t+"'")),Promise.resolve(c(t))}catch(r){return Promise.reject(r)}};if(o.startsWith("updateById"))return function(r,e,t){void 0===t&&(t={});try{var s=""+n+r+"?"+l.stringify({options:t}),f={data:{update:e}};return!0===u&&(console.log({fnName:a,uri:n,name:o,verb:i}),console.log(i+" '"+s+"' with data: "+JSON.stringify(f))),Promise.resolve(c(s,f))}catch(r){return Promise.reject(r)}};if(o.startsWith("updateByQuery"))return function(r,e,t){void 0===t&&(t={});try{var s=n+"?"+l.stringify({filter:r,options:t}),f={data:{update:e}};return!0===u&&(console.log({fnName:a,uri:n,name:o,verb:i}),console.log(i+" '"+s+"' with data: "+JSON.stringify(f))),Promise.resolve(c(s,f))}catch(r){return Promise.reject(r)}}}return function(r){var e=r.body,t=r.query,s=r.params;try{var f=n+"?"+l.stringify({query:t}),d={data:e,params:s};return!0===u&&(console.log({fnName:a,uri:n,name:o,verb:i}),console.log(i+" '"+f+"' with data: "+JSON.stringify(d))),Promise.resolve(c(f,d))}catch(r){return Promise.reject(r)}}}(u[0],{get:n,post:o,put:i,del:s},{debug:a,fnName:c});return v({},r,((t={})[c]=f,t))},{});return c}(e,{get:t.get,post:t.post,put:t.put,del:t.del},{debug:B});return!0===B&&Object.entries(o).map(function(r){console.log(r[0]+": "+r[1].toString())}),o})}catch(r){return Promise.reject(r)}};export{m as default,m as smallapi};
//# sourceMappingURL=index.m.js.map
